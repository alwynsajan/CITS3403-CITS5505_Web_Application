{% extends "base.html" %}

{% block content %}
<div class="dashboard-grid">
    <!-- Account Balance Card -->
    <div class="card">
        <h3>Account Balance</h3>
        {% if data.hasAccountBlance %}
            <div class="balance-content">
                <h2>${{ data.balance }}</h2>
            </div>
        {% else %}
            <div class="placeholder-content">
                <h2>$0.0</h2>
                <p class="placeholder-text">Add your income to see your balance</p>
            </div>
        {% endif %}
    </div>

    <!-- Goal Progress Card -->
    <div class="card" id="goalProgressCard">
        <h3>Goal Progress</h3>
        {% if data.hasGoal %}
            <div class="goal-content">
                <div class="progress-circle" style="--progress-percent: {{ data.goal_progress }}">
                    <div class="progress-circle-inner">
                        <h2>{{ data.goal_progress }}%</h2>
                        <p>{{ data.goal_name }}</p>
                    </div>
                </div>
                <div class="goal-details">
                    <p>Target: ${{ data.goal_target }}</p>
                    <p>Saved: ${{ data.goal_saved }}</p>
                    <p>Remaining: ${{ data.goal_target - data.goal_saved }}</p>
                </div>
            </div>
        {% else %}
            <div class="placeholder-content">
                <p class="placeholder-text">Set a goal to track progress</p>
            </div>
        {% endif %}
    </div>

    <!-- Set Goal Form Card -->
    <div class="card">
        <h3>Set a Goal</h3>
        <div id="goalFormMessage" class="form-message"></div>
        
        <form id="goalForm" class="goal-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="target_amount">Target Savings Amount</label>
                    <input type="number" id="target_amount" name="target_amount" placeholder="Enter amount" required>
                </div>
                
                <div class="form-group">
                    <label for="time_duration">Duration</label>
                    <select id="time_duration" name="time_duration">
                        <option value="weeks">Weeks</option>
                        <option value="months">Months</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="income_frequency">Income Frequency</label>
                    <select id="income_frequency" name="income_frequency">
                        <option value="weekly">Weekly</option>
                        <option value="fortnightly">Fortnightly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="income_amount">Salary ($)</label>
                    <input type="number" id="income_amount" name="income_amount" placeholder="Enter salary" required>
                </div>
                
                <div class="form-group">
                    <label for="allocation">Percentage Allocation</label>
                    <input type="number" id="allocation" name="allocation" placeholder="Enter percentage" required>
                </div>
            </div>
            
            <button type="submit" class="btn-primary">Add Goal</button>
        </form>
    </div>

    <!-- Budget Suggestion Card -->
    <div class="card">
        <h3>Budget Suggestion</h3>
        {% if data.hasSalary %}
            <div class="budget-content">
                <div class="budget-item">
                    <div class="budget-category needs">50%</div>
                    <div class="budget-info">
                        <h4>Needs</h4>
                        <p>${{ data.needs_amount }}</p>
                    </div>
                </div>
                
                <div class="budget-item">
                    <div class="budget-category wants">30%</div>
                    <div class="budget-info">
                        <h4>Wants</h4>
                        <p>${{ data.wants_amount }}</p>
                    </div>
                </div>
                
                <div class="budget-item">
                    <div class="budget-category savings">20%</div>
                    <div class="budget-info">
                        <h4>Savings</h4>
                        <p>${{ data.savings_amount }}</p>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="placeholder-content">
                <p class="placeholder-text">Add salary to get suggestions</p>
            </div>
        {% endif %}
    </div>

    <!-- Monthly Spending Chart Card -->
    <div class="card">
        <h3>Monthly Spending</h3>
        {% if data.hasExpense %}
            <div class="chart-container">
                <canvas id="spendingChart"></canvas>
            </div>
        {% else %}
            <div class="placeholder-content">
                <p class="placeholder-text">No spending data to display</p>
            </div>
        {% endif %}
    </div>

    <!-- Export Options Card -->
    <div class="card">
        <h3>Export</h3>
        <div class="export-buttons">
            <button class="btn-export">Export to CSV</button>
            <button class="btn-export">Export to PDF</button>
        </div>
    </div>
</div>

<!-- Chart.js script for the spending chart (only included when expense data exists) -->
{% if data.hasExpense %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('spendingChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Monthly Spending',
                    data: [{{ data.monthly_spending|join(', ') }}],
                    backgroundColor: 'rgba(83, 111, 255, 0.1)',
                    borderColor: '#536fff',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    });
</script>
{% endif %}

<!-- AJAX form handling script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const goalForm = document.getElementById('goalForm');
    const messageDiv = document.getElementById('goalFormMessage');
    const goalProgressCard = document.getElementById('goalProgressCard');
    
    if (goalForm) {
        goalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            messageDiv.innerHTML = '<p class="loading-message">Processing your request...</p>';
            
            const formData = new FormData(goalForm);
            
            fetch('/addGoal', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    messageDiv.innerHTML = `<p class="success-message">${data.message}</p>`;
                    goalForm.reset();
                    
                    // Update goal progress section
                    const goalHTML = `
                        <h3>Goal Progress</h3>
                        <div class="goal-content">
                            <div class="progress-circle" style="--progress-percent: ${data.goal.progress}">
                                <div class="progress-circle-inner">
                                    <h2>${data.goal.progress}%</h2>
                                    <p>${data.goal.name}</p>
                                </div>
                            </div>
                            <div class="goal-details">
                                <p>Target: $${data.goal.target}</p>
                                <p>Saved: $${data.goal.saved}</p>
                                <p>Remaining: $${data.goal.target - data.goal.saved}</p>
                            </div>
                        </div>
                    `;
                    
                    goalProgressCard.innerHTML = goalHTML;
                } else {
                    messageDiv.innerHTML = `<p class="error-message">${data.message}</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageDiv.innerHTML = '<p class="error-message">An error occurred. Please try again.</p>';
            });
        });
    }
});
</script>
{% endblock %}