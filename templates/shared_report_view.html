{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Shared Report</li>
                </ol>
            </nav>
            
            <div id="reportHeader" class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 id="reportTitle">Shared Report</h2>
                    <a href="/dashboard" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
                <div id="senderInfo" class="mt-2"></div>
            </div>
            
            <!-- Reports will be loaded here -->
            <div id="reportContent" class="mt-4">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading shared report data...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Setup active navigation state
        setupActiveNavigation();
        
        // Try to get report data from sessionStorage
        const reportDataString = sessionStorage.getItem('sharedReportData');
        
        if (reportDataString) {
            try {
                const reportData = JSON.parse(reportDataString);
                displaySharedReportPage(reportData);
            } catch (error) {
                console.error('Error parsing report data:', error);
                showErrorMessage('Invalid report data format');
            }
        } else {
            showErrorMessage('No report data found');
        }
        
        // Clear the sessionStorage after displaying
        sessionStorage.removeItem('sharedReportData');
    });
    
    function displaySharedReportPage(data) {
        // Update sender information
        const senderInfo = document.getElementById('senderInfo');
        if (senderInfo) {
            senderInfo.innerHTML = `
                <div class="alert alert-info d-flex align-items-center">
                    <i class="fas fa-user-circle fa-2x me-3"></i>
                    <div>
                        <strong>Shared by:</strong> ${data.senderFirstName} ${data.senderLastName}
                    </div>
                </div>
            `;
        }
        
        // Update title
        const reportTitle = document.getElementById('reportTitle');
        if (reportTitle) {
            reportTitle.textContent = `Report from ${data.senderFirstName} ${data.senderLastName}`;
        }
        
        // Display report content
        const reportContent = document.getElementById('reportContent');
        if (reportContent) {
            // Determine which type of report to display
            if (data.dashboardData) {
                reportContent.innerHTML = createDashboardReportHTML(data.dashboardData);
            } else if (data.expenseData) {
                reportContent.innerHTML = createExpenseReportHTML(data.expenseData);
            } else {
                showErrorMessage('No valid report data found');
            }
        }
    }
    
    function showErrorMessage(message) {
        const reportContent = document.getElementById('reportContent');
        if (reportContent) {
            reportContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${message}</span>
                </div>
                <div class="text-center mt-4">
                    <a href="/dashboard" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i>Return to Dashboard
                    </a>
                </div>
            `;
        }
    }

    /**
     * Setup Add Salary button functionality
     */
    function setupAddSalaryButton() {
        const addSalaryButtons = document.querySelectorAll('.add-salary-btn');
        const salaryModal = document.getElementById('salaryModal');
        
        if (!addSalaryButtons.length || !salaryModal) {
            console.log('Salary buttons or modal not found');
            return;
        }
        
        const salaryModalInstance = new bootstrap.Modal(salaryModal);
        
        // Add click event listeners to all salary buttons
        addSalaryButtons.forEach(button => {
            button.addEventListener('click', function() {
                salaryModalInstance.show();
            });
        });
        
        console.log('Salary buttons setup completed');
    }

    function setupEventListeners() {
        // Setup expense form submission listener if the form exists
        setupExpenseFormListeners();
        
        // Setup goal form submission
        const addGoalBtn = document.querySelector('.add-goal-btn');
        const goalModal = document.getElementById('goalModal');
        
        if (addGoalBtn && goalModal) {
            addGoalBtn.addEventListener('click', function() {
                const goalModalInstance = new bootstrap.Modal(goalModal);
                goalModalInstance.show();
            });
            
            // Ensure save goal button has event listener
            const saveGoalBtn = document.getElementById('saveGoalBtn');
            if (saveGoalBtn) {
                saveGoalBtn.addEventListener('click', saveNewGoal);
            }
        }
        
        // ... any other event listeners setup
    }
</script>
{% endblock %} 